<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è Live Agricultural Detection - USA Satellite Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0D1B2A 0%, #1B263B 50%, #415A77 100%);
            color: white;
            overflow-x: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            border-bottom: 3px solid #00D4AA;
            box-shadow: 0 4px 30px rgba(0, 212, 170, 0.3);
        }

        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #00D4AA, #4ECDC4, #45B7D1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            display: inline-block;
        }

        .live-status {
            float: right;
            margin-top: 5px;
        }

        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 8px;
            animation: pulse 2s infinite;
        }

        .status-dot.live { background: #00FF88; }
        .status-dot.processing { background: #FFB800; }
        .status-dot.satellite { background: #4ECDC4; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .main-layout {
            margin-top: 80px;
            height: calc(100vh - 80px);
            display: grid;
            grid-template-columns: 320px 1fr 350px;
            grid-template-rows: 1fr;
            gap: 15px;
            padding: 15px;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #00D4AA;
            box-shadow: 0 8px 40px rgba(0, 212, 170, 0.2);
            overflow-y: auto;
        }

        .control-section {
            background: rgba(0, 212, 170, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .control-section h3 {
            color: #00D4AA;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .btn {
            background: linear-gradient(45deg, #00D4AA, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
            width: 100%;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 170, 0.4);
        }

        .btn.danger {
            background: linear-gradient(45deg, #FF6B6B, #EE5A52);
        }

        .satellite-viewer {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            border: 2px solid #00D4AA;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .viewer-header {
            background: rgba(0, 212, 170, 0.2);
            padding: 15px;
            border-bottom: 1px solid #00D4AA;
            text-align: center;
        }

        .viewer-header h2 {
            color: #00D4AA;
            font-size: 1.3rem;
            margin-bottom: 8px;
        }

        .viewer-stats {
            display: flex;
            justify-content: space-around;
            font-size: 0.9rem;
            color: #4ECDC4;
        }

        #usaViewer {
            flex: 1;
            background: linear-gradient(180deg, #1B263B 0%, #0D1B2A 100%);
            position: relative;
        }

        .metrics-panel {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #00D4AA;
            overflow-y: auto;
        }

        .metric-card {
            background: rgba(0, 212, 170, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 212, 170, 0.3);
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 170, 0.2);
        }

        .metric-card h4 {
            color: #00D4AA;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #4ECDC4;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #ccc;
        }

        .metric-change {
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .metric-change.positive { color: #00FF88; }
        .metric-change.negative { color: #FF6B6B; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00D4AA, #4ECDC4);
            width: 0%;
            transition: width 1s ease;
            border-radius: 4px;
        }

        .satellite-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .detection-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            animation: detectionPulse 2s infinite;
        }

        .detection-marker.crop {
            background: #00FF88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
        }

        .detection-marker.building {
            background: #FFB800;
            box-shadow: 0 0 20px rgba(255, 184, 0, 0.6);
        }

        .detection-marker.mixed {
            background: linear-gradient(45deg, #00FF88, #FFB800);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.8);
        }

        @keyframes detectionPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.7; }
        }

        .live-feed {
            background: rgba(0, 212, 170, 0.05);
            border: 1px solid rgba(0, 212, 170, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            height: 180px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .feed-line {
            margin: 3px 0;
            padding: 2px 0;
            animation: fadeIn 0.5s ease-in;
        }

        .feed-line.detection { color: #00FF88; }
        .feed-line.processing { color: #FFB800; }
        .feed-line.satellite { color: #4ECDC4; }
        .feed-line.error { color: #FF6B6B; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .chart-container {
            background: rgba(0, 212, 170, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            height: 220px;
        }

        .chart-title {
            color: #00D4AA;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 25px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid #00D4AA;
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .satellite-controls {
            background: rgba(0, 212, 170, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .satellite-controls label {
            display: block;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .satellite-controls input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .satellite-controls select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #00D4AA;
            background: rgba(0, 0, 0, 0.8);
            color: white;
        }

        .detection-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: rgba(0, 212, 170, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ECDC4;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 5px;
        }

        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            .control-panel, .metrics-panel {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ∞Ô∏è Live Agricultural Detection - USA Satellite Monitoring</h1>
        <div class="live-status">
            <span>Live Feed <div class="status-dot live"></div></span>
            <span>Satellite <div class="status-dot satellite"></div></span>
            <span>Processing <div class="status-dot processing"></div></span>
        </div>
    </div>

    <div class="main-layout">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-section">
                <h3>üõ∞Ô∏è Satellite Source</h3>
                <div class="satellite-controls">
                    <label>Satellite Provider:</label>
                    <select id="satelliteProvider">
                        <option value="nasa">NASA Landsat-9</option>
                        <option value="google">Google Earth Engine</option>
                        <option value="sentinel">Sentinel-2</option>
                        <option value="modis">MODIS Terra</option>
                    </select>
                    
                    <label>Resolution: <span id="resolutionValue">10m</span></label>
                    <input type="range" id="resolutionSlider" min="5" max="50" value="10">
                    
                    <label>Update Frequency: <span id="updateValue">5s</span></label>
                    <input type="range" id="updateSlider" min="1" max="30" value="5">
                </div>
            </div>

            <div class="control-section">
                <h3>üéØ Detection Settings</h3>
                <div style="margin: 15px 0;">
                    <label><input type="checkbox" id="cropDetection" checked> Crop Field Detection</label>
                </div>
                <div style="margin: 15px 0;">
                    <label><input type="checkbox" id="buildingDetection" checked> Building Detection</label>
                </div>
                <div style="margin: 15px 0;">
                    <label><input type="checkbox" id="adaptiveFusion" checked> Adaptive Fusion RL</label>
                </div>
                <div style="margin: 15px 0;">
                    <label><input type="checkbox" id="realTimeTraining" checked> Real-time Learning</label>
                </div>
            </div>

            <div class="control-section">
                <h3>üåç USA Region Selection</h3>
                <div class="satellite-controls">
                    <label>State Focus:</label>
                    <select id="stateSelect">
                        <option value="all">All USA States</option>
                        <option value="california">California</option>
                        <option value="texas">Texas</option>
                        <option value="iowa">Iowa</option>
                        <option value="illinois">Illinois</option>
                        <option value="nebraska">Nebraska</option>
                    </select>
                    
                    <label>Crop Season:</label>
                    <select id="seasonSelect">
                        <option value="current">Current Season</option>
                        <option value="spring">Spring Planting</option>
                        <option value="summer">Summer Growth</option>
                        <option value="fall">Fall Harvest</option>
                    </select>
                </div>
            </div>

            <div class="control-section">
                <h3>‚ö° Live Controls</h3>
                <button class="btn" id="startLiveDetection">üöÄ Start Live Detection</button>
                <button class="btn" id="pauseDetection">‚è∏Ô∏è Pause Detection</button>
                <button class="btn danger" id="stopDetection">‚èπÔ∏è Stop Detection</button>
                <button class="btn" id="exportResults">üíæ Export Results</button>
            </div>
        </div>

        <!-- Main Satellite Viewer -->
        <div class="satellite-viewer">
            <div class="viewer-header">
                <h2>üá∫üá∏ Live USA Agricultural Satellite Feed</h2>
                <div class="viewer-stats">
                    <span>Resolution: <strong id="currentResolution">10m/pixel</strong></span>
                    <span>Coverage: <strong id="currentCoverage">28 States</strong></span>
                    <span>Last Update: <strong id="lastUpdate">Live</strong></span>
                </div>
            </div>
            <div id="usaViewer">
                <div class="satellite-overlay" id="detectionOverlay"></div>
            </div>
        </div>

        <!-- Metrics Panel -->
        <div class="metrics-panel">
            <div class="metric-card">
                <h4>üåæ Agricultural Detection</h4>
                <div class="metric-value" id="cropAccuracy">0.000</div>
                <div class="metric-label">Crop Field Accuracy (IoU)</div>
                <div class="metric-change positive" id="cropChange">+0.00%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="cropProgress"></div>
                </div>
            </div>

            <div class="metric-card">
                <h4>üè¢ Building Detection</h4>
                <div class="metric-value" id="buildingAccuracy">0.000</div>
                <div class="metric-label">Building Detection (IoU)</div>
                <div class="metric-change positive" id="buildingChange">+0.00%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="buildingProgress"></div>
                </div>
            </div>

            <div class="metric-card">
                <h4>ü§ñ Adaptive Fusion Performance</h4>
                <div class="detection-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="rlReward">0.85</div>
                        <div class="stat-label">RL Reward</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="fusionAccuracy">92%</div>
                        <div class="stat-label">Fusion Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processSpeed">2.3s</div>
                        <div class="stat-label">Processing Speed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeRegions">8</div>
                        <div class="stat-label">Active Regions</div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìà Real-time Performance Trends</div>
                <div id="performanceChart" style="width: 100%; height: 180px;"></div>
            </div>

            <div class="metric-card">
                <h4>üõ∞Ô∏è Satellite Data Status</h4>
                <div style="font-size: 0.9rem; line-height: 1.6;">
                    <div>Provider: <strong id="activeProvider">NASA Landsat-9</strong></div>
                    <div>Images Processed: <strong id="imagesProcessed">1,247</strong></div>
                    <div>Data Latency: <strong id="dataLatency">2.1s</strong></div>
                    <div>Cloud Cover: <strong id="cloudCover">12%</strong></div>
                </div>
            </div>

            <div class="live-feed" id="liveFeed">
                <div class="feed-line satellite">[SATELLITE] NASA Landsat-9 connection established</div>
                <div class="feed-line processing">[PROCESSING] Adaptive fusion RL agent initialized</div>
                <div class="feed-line detection">[DETECTION] Agricultural monitoring started</div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global Configuration
        const CONFIG = {
            API_BASE: 'http://localhost:8004',
            WS_URL: 'ws://localhost:8004/ws/live-satellite-feed',
            API_KEY: 'satellite-agriculture-live-2024',
            SATELLITE_ENDPOINTS: {
                providers: '/api/satellite/providers',
                regions: '/api/usa/agricultural-regions',
                start_live: '/api/live/start-detection',
                get_image: '/api/satellite/image'
            }
        };

        // Global State
        let isLiveDetectionActive = false;
        let websocket = null;
        let performanceData = [];
        let detectionMarkers = [];
        let satelliteViewer = null;

        // USA State Coordinates for satellite focus
        const USA_REGIONS = {
            california: { lat: 36.7783, lng: -119.4179, zoom: 6 },
            texas: { lat: 31.9686, lng: -99.9018, zoom: 6 },
            iowa: { lat: 42.0046, lng: -93.2140, zoom: 7 },
            illinois: { lat: 40.6331, lng: -89.3985, zoom: 7 },
            nebraska: { lat: 41.4925, lng: -99.9018, zoom: 7 },
            all: { lat: 39.8283, lng: -98.5795, zoom: 4 }
        };

        // Initialize Application
        async function initializeApp() {
            try {
                setupUSASatelliteViewer();
                setupEventListeners();
                connectWebSocket();
                startLiveUpdates();
                initializePerformanceChart();
                
                addFeedLine('System initialized successfully', 'detection');
                showNotification('Live Agricultural Detection System Ready', 'success');
                
                // Start with live detection
                setTimeout(() => startLiveDetection(), 2000);
                
            } catch (error) {
                addFeedLine(`Initialization error: ${error.message}`, 'error');
                showNotification('Initialization failed', 'error');
            }
        }

        // Setup USA Satellite Viewer
        function setupUSASatelliteViewer() {
            const viewer = document.getElementById('usaViewer');
            
            // Create satellite viewer canvas
            const canvas = document.createElement('canvas');
            canvas.width = viewer.clientWidth;
            canvas.height = viewer.clientHeight;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.id = 'satelliteCanvas';
            viewer.appendChild(canvas);
            
            // Initialize satellite simulation
            initializeSatelliteSimulation(canvas);
            
            addFeedLine('USA satellite viewer initialized', 'satellite');
        }

        // Initialize Satellite Simulation
        function initializeSatelliteSimulation(canvas) {
            const ctx = canvas.getContext('2d');
            
            // Draw USA map background
            drawUSABackground(ctx);
            
            // Add state boundaries and labels
            drawStateBoundaries(ctx);
            
            satelliteViewer = { canvas, ctx };
        }

        // Draw USA Background
        function drawUSABackground(ctx) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#1B263B');
            gradient.addColorStop(1, '#0D1B2A');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Draw simplified USA outline
            ctx.strokeStyle = '#00D4AA';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            // Simplified USA border (approximate)
            const usaPath = [
                [0.15 * width, 0.3 * height], // Northwest
                [0.85 * width, 0.25 * height], // Northeast
                [0.9 * width, 0.4 * height], // East coast
                [0.88 * width, 0.8 * height], // Southeast
                [0.75 * width, 0.85 * height], // Florida
                [0.2 * width, 0.9 * height], // Southwest
                [0.1 * width, 0.7 * height], // West coast
                [0.05 * width, 0.5 * height] // Pacific Northwest
            ];
            
            ctx.moveTo(usaPath[0][0], usaPath[0][1]);
            for (let i = 1; i < usaPath.length; i++) {
                ctx.lineTo(usaPath[i][0], usaPath[i][1]);
            }
            ctx.closePath();
            ctx.stroke();
            
            // Add USA label
            ctx.fillStyle = '#4ECDC4';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('UNITED STATES', width / 2, height / 2);
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Agricultural Satellite Monitoring', width / 2, height / 2 + 30);
        }

        // Draw State Boundaries
        function drawStateBoundaries(ctx) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            
            ctx.strokeStyle = 'rgba(0, 212, 170, 0.3)';
            ctx.lineWidth = 1;
            
            // Draw grid representing state divisions
            for (let i = 1; i < 6; i++) {
                // Vertical lines
                ctx.beginPath();
                ctx.moveTo(i * width / 6, 0.2 * height);
                ctx.lineTo(i * width / 6, 0.9 * height);
                ctx.stroke();
                
                // Horizontal lines
                ctx.beginPath();
                ctx.moveTo(0.1 * width, i * height / 6);
                ctx.lineTo(0.9 * width, i * height / 6);
                ctx.stroke();
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Slider updates
            document.getElementById('resolutionSlider').oninput = (e) => {
                document.getElementById('resolutionValue').textContent = e.target.value + 'm';
                updateSatelliteSettings();
            };
            
            document.getElementById('updateSlider').oninput = (e) => {
                document.getElementById('updateValue').textContent = e.target.value + 's';
                updateLiveFrequency(parseInt(e.target.value));
            };
            
            // Control buttons
            document.getElementById('startLiveDetection').onclick = startLiveDetection;
            document.getElementById('pauseDetection').onclick = pauseDetection;
            document.getElementById('stopDetection').onclick = stopDetection;
            document.getElementById('exportResults').onclick = exportResults;
            
            // Settings changes
            document.getElementById('satelliteProvider').onchange = updateSatelliteProvider;
            document.getElementById('stateSelect').onchange = updateRegionFocus;
            document.getElementById('seasonSelect').onchange = updateSeasonFocus;
        }

        // Start Live Detection
        async function startLiveDetection() {
            if (isLiveDetectionActive) return;
            
            isLiveDetectionActive = true;
            addFeedLine('Starting live satellite agricultural detection...', 'processing');
            
            try {
                // Get current settings
                const provider = document.getElementById('satelliteProvider').value;
                const region = document.getElementById('stateSelect').value;
                const updateFreq = parseInt(document.getElementById('updateSlider').value);
                const cropDetection = document.getElementById('cropDetection').checked;
                const buildingDetection = document.getElementById('buildingDetection').checked;
                const adaptiveFusion = document.getElementById('adaptiveFusion').checked;
                const realTimeTraining = document.getElementById('realTimeTraining').checked;
                
                // Start live detection via API
                const response = await fetch(`${CONFIG.API_BASE}${CONFIG.SATELLITE_ENDPOINTS.start_live}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        satellite_provider: provider,
                        region: region,
                        detection_types: [
                            ...(cropDetection ? ['crop'] : []),
                            ...(buildingDetection ? ['building'] : [])
                        ],
                        adaptive_fusion: adaptiveFusion,
                        real_time_training: realTimeTraining,
                        update_frequency: updateFreq
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    addFeedLine(`Live detection session started: ${data.session_id}`, 'detection');
                    addFeedLine(`Provider: ${provider.toUpperCase()}, Region: ${region}`, 'satellite');
                    
                    // Start detection monitoring
                    startDetectionMonitoring(data.session_id);
                    
                    showNotification('Live satellite detection started successfully', 'success');
                } else {
                    throw new Error('Failed to start detection session');
                }
                
            } catch (error) {
                addFeedLine(`Failed to start detection: ${error.message}`, 'error');
                showNotification('Failed to start live detection', 'error');
                isLiveDetectionActive = false;
            }
        }

        // Start Detection Simulation
        function startDetectionSimulation() {
            if (!isLiveDetectionActive) return;
            
            // Simulate detection events
            setInterval(() => {
                if (!isLiveDetectionActive) return;
                
                // Generate random detection
                simulateDetectionEvent();
                
                // Update metrics
                updateLiveMetrics();
                
            }, 2000 + Math.random() * 3000); // Random interval 2-5 seconds
        }

        // Simulate Detection Event
        function simulateDetectionEvent() {
            if (!satelliteViewer) return;
            
            const canvas = satelliteViewer.canvas;
            const ctx = satelliteViewer.ctx;
            
            // Generate random detection coordinates
            const x = 0.15 * canvas.width + Math.random() * 0.7 * canvas.width;
            const y = 0.3 * canvas.height + Math.random() * 0.5 * canvas.height;
            
            // Random detection type
            const detectionTypes = ['crop', 'building', 'mixed'];
            const type = detectionTypes[Math.floor(Math.random() * detectionTypes.length)];
            
            // Create detection marker
            createDetectionMarker(x, y, type);
            
            // Log detection
            const accuracy = (0.75 + Math.random() * 0.2).toFixed(3);
            addFeedLine(`[DETECTION] ${type} detected at (${x.toFixed(0)}, ${y.toFixed(0)}) - IoU: ${accuracy}`, 'detection');
        }

        // Create Detection Marker
        function createDetectionMarker(x, y, type) {
            const overlay = document.getElementById('detectionOverlay');
            
            const marker = document.createElement('div');
            marker.className = `detection-marker ${type}`;
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            
            overlay.appendChild(marker);
            
            // Store marker for tracking
            detectionMarkers.push({
                element: marker,
                type: type,
                timestamp: Date.now()
            });
            
            // Remove old markers
            if (detectionMarkers.length > 50) {
                const oldMarker = detectionMarkers.shift();
                if (oldMarker.element.parentNode) {
                    oldMarker.element.parentNode.removeChild(oldMarker.element);
                }
            }
        }

        // Update Live Metrics
        function updateLiveMetrics() {
            // Simulate improving metrics
            const cropAccuracy = Math.min(0.95, 0.65 + Math.random() * 0.3);
            const buildingAccuracy = Math.min(0.92, 0.70 + Math.random() * 0.25);
            const rlReward = Math.min(1.0, 0.75 + Math.random() * 0.2);
            
            // Update UI
            document.getElementById('cropAccuracy').textContent = cropAccuracy.toFixed(3);
            document.getElementById('buildingAccuracy').textContent = buildingAccuracy.toFixed(3);
            document.getElementById('rlReward').textContent = rlReward.toFixed(2);
            
            // Update progress bars
            document.getElementById('cropProgress').style.width = (cropAccuracy * 100) + '%';
            document.getElementById('buildingProgress').style.width = (buildingAccuracy * 100) + '%';
            
            // Update stats
            document.getElementById('fusionAccuracy').textContent = Math.floor(85 + Math.random() * 10) + '%';
            document.getElementById('processSpeed').textContent = (1.8 + Math.random() * 1.0).toFixed(1) + 's';
            document.getElementById('activeRegions').textContent = Math.floor(6 + Math.random() * 4);
            
            // Add to performance data
            performanceData.push({
                timestamp: Date.now(),
                crop: cropAccuracy,
                building: buildingAccuracy,
                reward: rlReward
            });
            
            // Keep only last 20 points
            if (performanceData.length > 20) {
                performanceData.shift();
            }
            
            updatePerformanceChart();
        }

        // Update Performance Chart
        function updatePerformanceChart() {
            if (performanceData.length < 2) return;
            
            const timestamps = performanceData.map(d => new Date(d.timestamp));
            const cropData = performanceData.map(d => d.crop);
            const buildingData = performanceData.map(d => d.building);
            const rewardData = performanceData.map(d => d.reward);
            
            const trace1 = {
                x: timestamps,
                y: cropData,
                name: 'Crop Detection',
                type: 'scatter',
                line: { color: '#00FF88' }
            };
            
            const trace2 = {
                x: timestamps,
                y: buildingData,
                name: 'Building Detection',
                type: 'scatter',
                line: { color: '#FFB800' }
            };
            
            const trace3 = {
                x: timestamps,
                y: rewardData,
                name: 'RL Reward',
                type: 'scatter',
                line: { color: '#4ECDC4' }
            };
            
            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#fff', size: 10 },
                margin: { t: 20, r: 20, b: 30, l: 40 },
                xaxis: { showgrid: false, color: '#4ECDC4' },
                yaxis: { showgrid: false, color: '#4ECDC4', range: [0, 1] },
                legend: { x: 0, y: 1, font: { size: 8 } }
            };
            
            Plotly.newPlot('performanceChart', [trace1, trace2, trace3], layout, { responsive: true, displayModeBar: false });
        }

        // Initialize Performance Chart
        function initializePerformanceChart() {
            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#fff' },
                margin: { t: 20, r: 20, b: 30, l: 40 },
                xaxis: { title: 'Time', showgrid: false, color: '#4ECDC4' },
                yaxis: { title: 'Performance', showgrid: false, color: '#4ECDC4', range: [0, 1] }
            };
            
            Plotly.newPlot('performanceChart', [], layout, { responsive: true, displayModeBar: false });
        }

        // Pause Detection
        function pauseDetection() {
            isLiveDetectionActive = false;
            addFeedLine('Detection paused', 'processing');
            showNotification('Live detection paused', 'info');
        }

        // Stop Detection
        function stopDetection() {
            isLiveDetectionActive = false;
            
            // Clear all markers
            detectionMarkers.forEach(marker => {
                if (marker.element.parentNode) {
                    marker.element.parentNode.removeChild(marker.element);
                }
            });
            detectionMarkers = [];
            
            addFeedLine('Detection stopped', 'processing');
            showNotification('Live detection stopped', 'info');
        }

        // Export Results
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                performance_data: performanceData,
                detection_count: detectionMarkers.length,
                settings: {
                    provider: document.getElementById('satelliteProvider').value,
                    resolution: document.getElementById('resolutionSlider').value,
                    state: document.getElementById('stateSelect').value
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agricultural_detection_results_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addFeedLine('Results exported successfully', 'detection');
            showNotification('Results exported to JSON file', 'success');
        }

        // Update Satellite Settings
        function updateSatelliteSettings() {
            const provider = document.getElementById('satelliteProvider').value;
            const resolution = document.getElementById('resolutionSlider').value;
            
            addFeedLine(`Satellite settings updated: ${provider} @ ${resolution}m`, 'satellite');
            document.getElementById('currentResolution').textContent = resolution + 'm/pixel';
            document.getElementById('activeProvider').textContent = provider.toUpperCase() + ' Satellite';
        }

        // Update Satellite Provider
        function updateSatelliteProvider() {
            const provider = document.getElementById('satelliteProvider').value;
            addFeedLine(`Switched to ${provider.toUpperCase()} satellite feed`, 'satellite');
            updateSatelliteSettings();
        }

        // Update Region Focus
        function updateRegionFocus() {
            const state = document.getElementById('stateSelect').value;
            const region = USA_REGIONS[state] || USA_REGIONS.all;
            
            addFeedLine(`Region focus changed to: ${state.toUpperCase()}`, 'satellite');
            
            // Update coverage display
            if (state === 'all') {
                document.getElementById('currentCoverage').textContent = '28 States';
            } else {
                document.getElementById('currentCoverage').textContent = state.charAt(0).toUpperCase() + state.slice(1);
            }
        }

        // Update Season Focus
        function updateSeasonFocus() {
            const season = document.getElementById('seasonSelect').value;
            addFeedLine(`Crop season focus: ${season}`, 'detection');
        }

        // Update Live Frequency
        function updateLiveFrequency(seconds) {
            addFeedLine(`Update frequency changed to ${seconds}s`, 'processing');
        }

        // Start Detection Monitoring
        function startDetectionMonitoring(sessionId) {
            // Monitor session progress
            const monitorInterval = setInterval(async () => {
                if (!isLiveDetectionActive) {
                    clearInterval(monitorInterval);
                    return;
                }
                
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/api/live/session/${sessionId}`);
                    const data = await response.json();
                    
                    if (data.session) {
                        updateSessionMetrics(data.session, data.rl_agent_stats);
                    }
                    
                } catch (error) {
                    addFeedLine(`Session monitoring error: ${error.message}`, 'error');
                }
            }, 3000);
        }

        // Update Session Metrics
        function updateSessionMetrics(session, rlStats) {
            // Update detection counts
            document.getElementById('imagesProcessed').textContent = session.images_processed.toLocaleString();
            document.getElementById('activeRegions').textContent = session.detections_count || 0;
            
            // Update accuracies
            if (session.current_accuracy) {
                const accuracy = session.current_accuracy;
                document.getElementById('cropAccuracy').textContent = accuracy.toFixed(3);
                document.getElementById('buildingAccuracy').textContent = (accuracy * 0.95).toFixed(3);
                
                document.getElementById('cropProgress').style.width = (accuracy * 100) + '%';
                document.getElementById('buildingProgress').style.width = (accuracy * 95) + '%';
            }
            
            // Update RL metrics
            if (rlStats) {
                document.getElementById('rlReward').textContent = (rlStats.avg_performance || 0.85).toFixed(2);
                document.getElementById('fusionAccuracy').textContent = Math.floor((rlStats.avg_performance || 0.85) * 100) + '%';
                
                addFeedLine(`RL Agent: Episode ${rlStats.total_episodes}, Œµ=${rlStats.epsilon.toFixed(3)}`, 'processing');
            }
        }

        // Connect WebSocket
        function connectWebSocket() {
            try {
                websocket = new WebSocket(CONFIG.WS_URL);
                
                websocket.onopen = () => {
                    addFeedLine('WebSocket connected to live satellite feed', 'satellite');
                };
                
                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketData(data);
                };
                
                websocket.onclose = () => {
                    addFeedLine('Satellite WebSocket disconnected', 'error');
                    setTimeout(connectWebSocket, 5000);
                };
                
            } catch (error) {
                addFeedLine(`WebSocket error: ${error.message}`, 'error');
            }
        }

        // Handle WebSocket Data
        function handleWebSocketData(data) {
            if (data.detection_event) {
                const event = data.detection_event;
                const results = event.results;
                
                // Create detection marker on map
                const coords = event.coordinates;
                const x = 0.15 * satelliteViewer.canvas.width + (coords.lng + 125) / 60 * 0.7 * satelliteViewer.canvas.width;
                const y = 0.3 * satelliteViewer.canvas.height + (49 - coords.lat) / 25 * 0.5 * satelliteViewer.canvas.height;
                
                const detectionType = results.crop_accuracy > results.building_accuracy ? 'crop' : 'building';
                createDetectionMarker(x, y, detectionType);
                
                // Update live feed
                addFeedLine(`[SATELLITE] Detection at (${coords.lat.toFixed(2)}, ${coords.lng.toFixed(2)})`, 'satellite');
                addFeedLine(`[DETECTION] ${detectionType} accuracy: ${results[detectionType + '_accuracy'].toFixed(3)}`, 'detection');
                
                // Update detected crops if available
                if (results.detected_crops && results.detected_crops.length > 0) {
                    addFeedLine(`[CROPS] Found: ${results.detected_crops.join(', ')}`, 'detection');
                }
            }
            
            if (data.session_stats) {
                const stats = data.session_stats;
                
                // Update processing statistics
                document.getElementById('imagesProcessed').textContent = stats.images_processed.toLocaleString();
                document.getElementById('activeRegions').textContent = stats.total_detections || 0;
                
                // Update accuracies
                if (stats.current_accuracy) {
                    document.getElementById('cropAccuracy').textContent = stats.current_accuracy.toFixed(3);
                    document.getElementById('buildingAccuracy').textContent = (stats.current_accuracy * 0.95).toFixed(3);
                    
                    document.getElementById('cropProgress').style.width = (stats.current_accuracy * 100) + '%';
                    document.getElementById('buildingProgress').style.width = (stats.current_accuracy * 95) + '%';
                }
                
                // Update RL metrics
                if (stats.rl_metrics) {
                    const rl = stats.rl_metrics;
                    document.getElementById('rlReward').textContent = (rl.avg_performance || 0.85).toFixed(2);
                    document.getElementById('fusionAccuracy').textContent = Math.floor((rl.avg_performance || 0.85) * 100) + '%';
                }
            }
        }

        // Start Live Updates
        function startLiveUpdates() {
            setInterval(() => {
                // Update timestamp
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
                // Update satellite stats
                document.getElementById('imagesProcessed').textContent = Math.floor(1200 + Math.random() * 100).toLocaleString();
                document.getElementById('dataLatency').textContent = (1.5 + Math.random() * 1.0).toFixed(1) + 's';
                document.getElementById('cloudCover').textContent = Math.floor(8 + Math.random() * 15) + '%';
                
            }, 5000);
        }

        // Add Feed Line
        function addFeedLine(message, type = 'processing') {
            const feed = document.getElementById('liveFeed');
            const line = document.createElement('div');
            line.className = `feed-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            feed.appendChild(line);
            feed.scrollTop = feed.scrollHeight;
            
            // Keep only last 50 lines
            while (feed.children.length > 50) {
                feed.removeChild(feed.firstChild);
            }
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>